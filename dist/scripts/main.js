"use strict";var width=10,height=10,startFps=5,fps=startFps,frameLength=1e3/fps,startX=2,startY=2,startLength=10,throughWalls=!0,bgColour="#ECF0F1",snakeHeadColour="#2B3E51",snakeColour="#305791",deadColour="#C23824",foodColour="#1AAF5D",scoreColour="#F2C500",SNAKE={},APP_VERSION=.1,touchEl=document.querySelector(".touch"),nameEl=document.querySelector("input.username"),hammertime=new Hammer.Manager(touchEl);hammertime.add(new Hammer.Swipe({direction:Hammer.DIRECTION_ALL})),hammertime.add(new Hammer.Tap({event:"doubletap",taps:2})),SNAKE.game=function(){function e(){s.fillStyle=bgColour,s.fillRect(0,0,width,height),u.drawScore(s),u.advance(),u.check().crash?(u.die(),o(),u.draw(s,!0)):(u.check().food&&(u.eat(),u.longer(1),u.speedup()),u.draw(s),setTimeout(e,frameLength))}function t(){function t(){u.isDead()&&(u.reset(),e())}var r={37:"left",38:"up",39:"right",40:"down"},n={2:"left",4:"right",8:"up",16:"down"};document.onkeydown=function(e){var n=e.which,o=r[n];o?(u.setDirection(o),e.preventDefault()):32===n&&t()},hammertime.on("swipe",function(e){e.preventDefault();var t=n[e.direction];t&&u.setDirection(t)}),hammertime.on("doubletap",function(e){e.preventDefault(),t()})}function r(){if(h)return void console.error("Dont init twice");h=!0;var r=document.querySelector("canvas.snake"),n=document.querySelector(".touch").clientWidth,o=document.querySelector(".touch").clientHeight,a=Math.min(n,o);r.style.width=.9*a+"px",r.style.height=.9*a+"px",r.width=width,r.height=height,s=r.getContext("2d"),u=SNAKE.snake(),t(),e(),c=new Firebase("https://snake-scores.firebaseio.com/")}function n(){return nameEl.value.toUpperCase()||"ANON"}function o(){var e=n(),t=u.getScore();c.push({name:e,score:t,appVersion:APP_VERSION})}function a(){var e=n();Cookies.set("username",e,{expires:1/0})}function i(e){nameEl.value=e}var s,u,c,h=!1,l=Cookies.get("username");return l&&i(l),nameEl.addEventListener("change",a),{init:r}}(),SNAKE.snake=function(){function e(){this.dead=!1,fps=startFps,frameLength=1e3/fps,p=[],v=[2,6];for(var e=0;startLength>e;e++)p.push([startX,startY-e]);S="right",k=S,C=k}function t(e){var t;switch(S){case"left":case"right":t=["up","down"];break;case"up":case"down":t=["left","right"];break;default:throw"Invalid direction"}t.indexOf(e)>-1?k=e:C=e}function r(){return p.length-startLength}function n(e){e.save(),e.fillStyle=scoreColour,e.font='8px "5x5 Pixel"',e.fillText(r(),1,height)}function o(e,t){var r=t[0],n=t[1];e.fillRect(r,n,1,1)}function a(e,t){e.save();for(var r=0;r<p.length;r++)0===r?e.fillStyle=snakeHeadColour:e.fillStyle=t?deadColour:snakeColour,o(e,p[r]);e.fillStyle=foodColour,o(e,v),e.restore()}function i(e,t){return(e%t+t)%t}function s(){var e=p[0].slice();switch(S=k,C&&(t(C),C=void 0),S){case"left":e[0]-=1;break;case"up":e[1]-=1;break;case"right":e[0]+=1;break;case"down":e[1]+=1;break;default:throw"Invalid direction"}throughWalls&&(e[0]=i(e[0],width),e[1]=i(e[1],height)),p.unshift(e),this.extend>0?this.extend--:p.pop()}function u(e,t){var r=e[0]===t[0]&&e[1]===t[1];return r}function c(e,t){var r=!1;return t.forEach(function(t){u(e,t)&&(r=!0)}),r}function h(){var e=!1,t=p[0],r=p.slice(1,-1),n=t[0],o=t[1],a=!1;e=!throughWalls&&0>n||n>=width||0>o||o>=height?!0:e,e=c(t,r)?!0:e,u(v,t)&&(a=!0);var i={};return i.crash=e,i.crashHead=t,i.food=a,i}function l(e){this.extend=e}function d(){var e=Math.floor(Math.random()*width),t=Math.floor(Math.random()*height),r=[e,t];c(r,p)?d():v=r}function f(){fps+=.1,frameLength=1e3/fps}function m(){this.dead=!0}function g(){return this.dead}this.dead=!1;for(var p=[],v=[2,6],w=0;startLength>w;w++)p.push([startX,startY-w]);var S="right",k=S,C=k;return{draw:a,advance:s,setDirection:t,check:h,longer:l,eat:d,drawScore:n,speedup:f,die:m,isDead:g,reset:e,getScore:r}},window.onload=SNAKE.game.init();